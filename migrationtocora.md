migrationtocora.md1. Migration Scope DefinitionFunctional ScopeThe RepoMap feature is a sophisticated context-awareness engine that indexes, ranks, and visualizes the most relevant code symbols from a repository to optimize the LLM's context window. "Repomap in its completeness" entails the following practical terms:Runtime Behavior:Automated Indexing: Upon startup or file change, the system parses codebase files using Tree-sitter to identify symbol definitions and references.Graph Construction: It builds a directed graph where nodes are files and edges represent usage dependencies, weighted by symbol importance and recency.PageRank Execution: It runs a personalized PageRank algorithm to score files based on the current user context (open tabs, active edits, mentions).Context Rendering: It generates a compressed "Tree Representation" (a syntactically valid skeleton) of the most important code to fit within a specific token budget (default 1024 tokens).Reactive UI: It updates a status indicator in the CLI footer in real-time as indexing proceeds or errors occur.Data Flow:File System → TagExtractor (Tree-sitter) → SQLite Cache → Dependency Graph → PageRank Scorer → Tree Renderer → LLM Context Window.Configuration:The feature is controlled via vibe/core/config.py (enabled status, token limits, exclusion patterns, refresh intervals).Implicit Dependencies:The feature strictly depends on Tree-sitter query files (.scm) matching the target languages. Without these, no symbols are extracted.It depends on AgentStats event emitters to notify the UI of progress without coupling the rendering logic to the analysis logic.Non-Functional ScopePerformance: The migration includes a diskcache (SQLite-backed) implementation to ensure subsequent runs are near-instantaneous.Resilience: The implementation includes fallback logic for languages without explicit Tree-sitter support (using Pygments) and error handling for malformed code.2. Folder-Level Migration PlanThe following directories must be copied from the source fork into the target fork.1. vibe/repomap/Purpose: This is the self-contained domain module for the feature. It contains the sub-modules for analysis, graph theory, ranking, and rendering.Why Migrate: It is the core engine. Moving it as a unit ensures internal import paths (.core, .tags, etc.) remain valid.Assumptions: It assumes the existence of vibe/core (for configuration objects) and standard Python system libraries.2. vibe/repomap/queries/Purpose: Contains language-specific Tree-sitter S-expressions (.scm files) used to query the Abstract Syntax Tree for definitions and references.Why Migrate: The TagExtractor relies on finding these files relative to its own path. Missing these files results in zero-knowledge parsing.Assumptions: Must be placed strictly within vibe/repomap/ so tags.py can locate them using Path(__file__).parent / "queries".3. File Creation Inventory (New Files Only)The following files do not exist in the target fork and must be created.Core Logic (vibe/repomap/)vibe/repomap/__init__.pyRole: Package marker.vibe/repomap/core.pyRole: The Facade. It exposes the RepoMap class and get_repo_map_with_diagnostics method. Orchestrates the pipeline.vibe/repomap/tags.pyRole: Extraction Engine. Interfaces with tree_sitter and grep_ast to produce Tag namedtuples from source code.vibe/repomap/graph.pyRole: Graph Analysis. Uses networkx to build the dependency graph and execute PageRank.vibe/repomap/rendering.pyRole: Presentation Layer. Formats the selected code snippets into the final string format for the LLM.vibe/repomap/analyzer.pyRole: Analysis Utility. Helper functions for code analysis tasks.vibe/repomap/discovery.pyRole: File System Scanner. Identifies relevant files while respecting exclusion patterns.vibe/repomap/exporter.pyRole: Debugging/Observability. Exports graph data (likely for debug/visualization).vibe/repomap/generator.pyRole: Logic for generating the map content.vibe/repomap/metrics.pyRole: Telemetry. definitions for tracking token usage and timing.vibe/repomap/schemas.pyRole: Data Contracts. Pydantic models or dataclasses used for internal data exchange.Query Files (vibe/repomap/queries/)All .scm files: bash.scm, c.scm, cairo.scm, clojure.scm, cpp.scm, csharp.scm, dart.scm, elixir.scm, elm.scm, erlang.scm, gdscript.scm, gleam.scm, go.scm, groovy.scm, haskell.scm, haxe.scm, java.scm, javascript.scm, julia.scm, kotlin.scm, lua.scm, matlab.scm, nix.scm, objc.scm, ocaml.scm, odin.scm, perl.scm, php.scm, purescript.scm, python.scm, r.scm, racket.scm, ruby.scm, rust.scm, scala.scm, solidity.scm, sql.scm, swift.scm, typescript.scm, v.scm, verilog.scm, zig.scm.Role: Syntax definitions for each supported language.UI Components (vibe/cli/textual_ui/widgets/)vibe/cli/textual_ui/widgets/repomap_status.pyRole: A Textual Static widget that listens for token count updates and renders the "RepoMap: 1024" status in the CLI footer.4. Modified File Change Log (Existing Files)1. pyproject.tomlPath: pyproject.tomlSummary: Added core dependencies for parsing, graph algorithms, and caching.Changes:dependencies list updated to include:"networkx>=3.0""tree-sitter>=0.25.2""tree-sitter-bash>=0.25.1""grep-ast>=0.3.3""diskcache>=5.6.3""pygments>=2.17.0"2. vibe/core/config.pyPath: vibe/core/config.pySummary: Introduced configuration schemas for Repomap settings.Changes:Added Class: RepoMapConfig(BaseSettings) containing:enabled: Boolean toggle.map_tokens: Integer limit (default 1024).refresh_interval: Integer.exclude_patterns: List of strings (defaults to standard ignores like node_modules).Modified Class: VibeConfigAdded field repo_map: RepoMapConfig = Field(default_factory=RepoMapConfig).3. vibe/cli/textual_ui/app.pyPath: vibe/cli/textual_ui/app.pySummary: Wired the status widget into the main application layout and event loop.Changes:Imports: Added RepoMapStatus from vibe.cli.textual_ui.widgets.repomap_status.Method compose:Added yield RepoMapStatus() to the #bottom-bar Horizontal container.Method on_mount:Retrieved the widget: repomap_status = self.query_one(RepoMapStatus).Event Binding: Registered listeners to AgentStats events (repo_map_tokens, repo_map_status) to invoke updates on the widget.Callback Logic: Added logic in update_context_progress to update repomap_status.tokens and repomap_status.status.5. Dependency & Integration AnalysisNew DependenciesTree-sitter: A compiled binding. Migration must ensure the target environment can build or install wheels for tree-sitter.NetworkX: Pure Python graph library. Low risk, standard dependency.Diskcache: Uses SQLite. Introduces file-system side effects (creation of .aider.tags.cache directories).Grep-ast: Utility for python-based AST traversal.Integration ArchitectureObserver Pattern: The system uses a decoupled observer pattern via AgentStats. The core logic updates stats, and the UI (app.py) listens to stats. This prevents circular dependencies between the CLI and the Core.Configuration Injection: RepoMap instances require the RepoMapConfig object injected at runtime, which is now provided by the updated VibeConfig.Order ConstraintsDependencies First: pyproject.toml must be applied and installed first, or imports in vibe/repomap/ will fail immediately.Config Second: vibe/core/config.py must be updated before vibe/repomap/core.py is instantiated, as it likely types hints or uses the config object.6. Migration Execution OrderDependency Injection:Update pyproject.toml.Run dependency install (uv sync, pip install, etc.).Configuration Schema Update:Apply changes to vibe/core/config.py.Core Feature Transfer:Create vibe/repomap/ directory.Copy all python files (core.py, tags.py, graph.py, etc.) into vibe/repomap/.Query File Transfer:Create vibe/repomap/queries/ directory.Copy all .scm files into this directory.UI Component Implementation:Create vibe/cli/textual_ui/widgets/repomap_status.py.Application Wiring:Apply changes to vibe/cli/textual_ui/app.py to instantiate and display the status widget.Sanity Check:Run vibe --help to ensure no import errors.7. Risk & Validation NotesRisksBinary Incompatibility: tree-sitter bindings might fail on non-standard architectures (e.g., Alpine Linux) if wheels aren't available.Missing Query Files: If the .scm files are misplaced (e.g., flattened into vibe/repomap instead of vibe/repomap/queries), the parser will fail silently or throw FileNotFoundError.Cache Write Permissions: If the application runs in a read-only container, diskcache might panic when trying to write to .aider.tags.cache.ValidationStatic: Verify import vibe.repomap.core works in a python shell.Runtime UI: Launch the Vibe CLI. Observe the bottom bar. It should show "RepoMap" status.Functional: Open a project with diverse languages (Python, JS). Wait 5-10 seconds. The "RepoMap" token count in the footer should jump from 0 to a positive integer (e.g., ~1024), indicating the graph has been built and rendered.
